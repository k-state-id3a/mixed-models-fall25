---
title: Fundamentals of linear mixed models 
nav: Day 1
topics: Linear models review; Fixed effects vs. random effects
---

- [Welcome!](#welcome-)
- [Housekeeping](#housekeeping)
- [Outline for today](#outline-for-today)
- [Linear models review](#linear-models-review)
  * [The famous intercept-and-slope linear model](#the-famous-intercept-and-slope-linear-model)
  * [Let's fit the same statistical model using distribution notation and matrix notation](#let-s-fit-the-same-statistical-model-using-distribution-notation-and-matrix-notation)
  * [Whiteboard example - qualitative predictor](#whiteboard-example---qualitative-predictor)
- [Variance-covariance matrices](#variance-covariance-matrices)
  * [What does variance even mean?](#what-does-variance-even-mean-)
  * [On the covariance of two random variables $$y_1$$ and $$y_2$$](#on-the-covariance-of-two-random-variables---y-1---and---y-2--)
- [Adding a random effect to the model](#adding-a-random-effect-to-the-model)
  * [Independent observations](#independent-observations)
  * [Non-independent observations](#non-independent-observations)
  * [How do we define $$\beta_{0j}$$?](#how-do-we-define----beta--0j----)
    + [Fixed](#fixed)
    + [Random](#random)
- [Generalities -- what are mixed models anyways?](#generalities----what-are-mixed-models-anyways-)
  * [Random effects](#random-effects)
  * [Fixed effects versus random effects](#fixed-effects-versus-random-effects)
- [Applied example](#applied-example)
  * [Building the model](#building-the-model)
- [Wrap-up](#wrap-up)
- [What's next](#what-s-next)

------------------

## Welcome!

- [About me](https://jlacasa.github.io/).
- About you.
  - Frequent responses to the registration survey.   
  - Some knowledge of the *existence* of mixed effects models.  
  - Mostly life sciences - often heteroscedasticity and dependent observations!  

{% include figure.html img="day1/attendees.jpg" alt="Attendees counts" caption="Figure 1. Distribution of Departments attending this worksop" width="75%" id = "attendees" %}

## Housekeeping  

- We will have relatively low proportion of R code in this workshop. 
Instead, we will focus on the understanding of the components of mixed-effects models. 
Questions/concerns via e-mail are encouraged.   
- Emphasis on modeling and figuring out what mixed-effects models actually do.  
- The statistical notation we will use throughout this workshop is presented [here](0-prep). 
- DON'T PANIC when you see all the math notation and matrices. We will go slowly together. 
It is also **not expected** that you walk out of this workshop as a math notation wizard! 

{% capture text %}
1. Fundamentals of linear mixed models  
   Review of linear models & basic concepts of linear mixed models     
3. Modeling data generated by designed experiments
5. Generalized linear mixed models (aka non-normal response) applied to designed experiments  
{% endcapture %}
{% include card.html text=text header="Workshop Overview" %}


## Outline for today

-   **Review of linear models**: begin with a refresher on linear models (all fixed-effects), then introduce mixed-effects models by incorporating an additional assumption.
-   **The variance-covariance matrix**: the information of the random effects is stored in the variance-covariance matrix!  
-   **Fixed effects vs. random effects**: where/how is the information from each type of effect captured?
-   **Application**: practical implications of these concepts when fitting a model to your data.

------

## Linear models review  

### The famous intercept-and-slope linear model

{% include figure.html img="day1/linear_regression_1.jpg" alt="" caption="Figure 2. A good example for the intercept-and-slope model: apple diameter versus time." width="75%" id = "intercept_slope_fig1" %}

One of the most popular models is the intercept-and-slope model. 
It's so simple and interpretable! 
Most of us learned a way of writing out the statistical model called "model equation form". 
For a quantitative predictor $$x$$, the model equation form is    

$$y_{i} = \beta_0 + x_{i} \beta_1 + \varepsilon_{i}, \\ \varepsilon_i \sim N(0, \sigma^2),$$  

where $$y_{i}$$ is the observed value for the $$i$$th observation, 
$$\beta_0$$ is the intercept (i.e., the expected value of $$y$$ when $$x=0$$), 
$$\beta_1$$ is the slope parameter (i.e., the expected increase in $$y_i$$ with a unity increase in $$x$$), 
$$x_i$$ is the predictor for the $$i$$th observation, 
and $$\varepsilon_{i}$$ is the difference between the observed value $$y$$ 
and the expected value $$E(y_i) = \beta_0+x_i\beta_1$$ - that's why we often call it "residual". 
Typically, $$\boldsymbol{\beta} \equiv \begin{bmatrix} \beta_0 \\ \beta_1 \end{bmatrix}$$ 
is estimated via maximum likelihood estimation. Also, when we assume a Normal distribution, 
maximum likelihood estimation yields the same point estimates as least squares estimation. 


Look at the plot above ([Figure 2](#intercept_slope_fig1)). 
The data are measurements of the diameter of apples that were **randomly selected from randomly selected trees** at different points in time.  

Can we fit the intercept-and-slope model to that data? 
Let's review the assumptions we make in this model (which is the default model in most software).   
- Linearity  
- Constant variance  
- Independence  
- Normality  


### Let's fit the same statistical model using distribution notation and matrix notation

There are other ways of writing out the statistical model above besides the model equation form. 
Instead of focusing on the distribution of the residuals, we can focus on the distribution of the data $$y$$:  

$$y_{i} \sim N(\mu_i, \sigma^2), \\ \mu_i = \beta_0 + x_{i} \beta_1.$$

This type of notation is called "probability distribution form". 
The probability distribution form makes it easier to switch to other distributions beyond the Normal ([Day 3](3-lesson) of this workshop). 
We can further express this equation using vectors and matrices:  

$$\mathbf{y} \sim N(\boldsymbol{\mu}, \Sigma), \\ \boldsymbol{\mu} = \boldsymbol{1} \boldsymbol{\beta_0} + \mathbf{x} \boldsymbol{\beta_1} = \mathbf{X}\boldsymbol{\beta},$$

where $$n$$ is the total number of observations, $$p$$ is the total number of parameters, 
$$\mathbf{y}$$ is an $$n \times 1$$ vector containing all observations, 
$$\boldsymbol{\mu}$$ is an $$n \times 1$$ vector containing the expected values of said observations, 
$$\boldsymbol{\beta}$$ is an $$p \times 1$$ vector containing the (fixed) parameters, 
$$\mathbf{X}$$ is an $$n \times p$$ matrix containing the predictors, 
$$\Sigma$$ is an $$n \times n$$ matrix called variance-covariance matrix. 
*Note: This type of notation is also convenient to think about how to prepare the data in your spreadsheet. One row per observation (rows in $$\mathbf{X}$$), one variable per column (columns in $$\mathbf{X}$$).*

Let's expand these expressions: 

$$\begin{bmatrix}y_1 \\ y_2 \\ \vdots \\ y_n \end{bmatrix} \sim  N \left( \begin{bmatrix}\mu_1 \\ \mu_2 \\ \vdots \\ \mu_n \end{bmatrix}, 
\begin{bmatrix} Cov(y_1, y_1) & Cov(y_1, y_2) & \dots & Cov(y_1, y_n) \\
Cov(y_2, y_1) & Cov(y_2, y_2) & \dots & Cov(y_2, y_n)\\
\vdots & \vdots & \ddots & \vdots \\ 
Cov(y_n, y_1) & Cov(y_n, y_2) & \dots & Cov(y_n, y_n) \end{bmatrix} \right),$$

which is the same as 

$$\begin{bmatrix}y_1 \\ y_2 \\ \vdots \\ y_n \end{bmatrix} \sim N \left( \begin{bmatrix}\mu_1 \\ \mu_2 \\ \vdots \\ \mu_n \end{bmatrix}, 
\begin{bmatrix} Var(y_1) & Cov(y_1, y_2) & \dots & Cov(y_1, y_n) \\
Cov(y_2, y_1) & Var(y_2) & \dots & Cov(y_2, y_n)\\
\vdots & \vdots & \ddots & \vdots \\ 
Cov(y_n, y_1) & Cov(y_n, y_2) & \dots & Var(y_n) \end{bmatrix} \right).$$

### Whiteboard example - qualitative predictor  

Instead of a quantitative predictor, we could have a qualitative (or categorical) predictor. 
If we have two possible levels, A and B, we could use the same model as before,  

$$y_{i} \sim N(\mu_i, \sigma^2), \\ \mu_i = \beta_0 + x_i \beta_1,$$

and say that $$y_{i}$$ is the observed value for the $$i$$th observation, 
$$\beta_0$$ is the expected value for A, 
$$x_i = 0$$ if the $$i$$th observation belongs to A, and $$x_i = 1$$ if the $$i$$th observation belongs to B, 
$$\beta_1$$ is the difference between A and B. 

- What happens if the categorical predictor have more than two levels? 

## Variance-covariance matrices  

### What does variance even mean?  

Random variables are usually described with their properties like the expected value and variance. 
The expected value and variance are the first and second central moments of a distribution, respectively. 
Regardless of the distribution of a random variable $$Y$$, we could calculate its expected value $$E(Y)$$ and variance $$Var(Y)$$. 
The expected value measures the average outcome of $$Y$$. 
The variance measures the dispersion of $$Y$$, i.e. how far the possible outcomes are spread out from their average. 

{% include figure.html img="day1/normal_univariate.png" alt="Univariate Normal distributions" caption="Figure 3. Normal distributions" width="75%" id = "univariate_normal" %}

**Discuss in the plot above:**  
-   Expected value  
-   Variance  
-   Covariance?

### On the covariance of two random variables $$y_1$$ and $$y_2$$    

Covariance between two random variables means how the two random variables behave relative to each other. 
Essentially, it quantifies the relationship between their joint variability. 
The variance of a random variable is the covariance of a random variable with itself. 
Consider two variables $$y_1$$ and $$y_2$$ each with a variance of 1 and a covariance of 0.6. 
The data shown in [Figure 4](#multivariate_normal) arise from the multivariate normal distribution

$$\begin{bmatrix}y_1 \\ y_2 \end{bmatrix} \sim MVN \left( \begin{bmatrix} 10 \\ 8 \end{bmatrix} , \begin{bmatrix}1 & 0.6 \\ 0.6 & 1 \end{bmatrix} \right),$$

where the means of $$y_1$$ and $$y_2$$ are 10 and 8, respectively, and their covariance structure is represented in the variance-covariance matrix. Remember, 

$$\begin{bmatrix}y_1 \\ y_2 \end{bmatrix} \sim MVN \left( \begin{bmatrix} E(y_1) \\ E(y_2) \end{bmatrix} , \begin{bmatrix} Var(y_1) & Cov(y_1, y_2) \\ Cov(y_2,y_2) & Var(y_2) \end{bmatrix} \right).$$

{% include figure.html img="day1/normal_multivariate.jpg" alt="Multivariate Normal distribution" caption="Figure 4. Multivariate Normal distribution showing the correlation between two random normal variables." width="75%" id = "multivariate_normal" %}

**Discuss in the plot above:**  
-   Expected value  
-   Variance  
-   Covariance 

## Adding a random effect to the model   

### Independent observations  

Back to the example in [Figure 2](#intercept_slope_fig1). Let's assume we have $$n$$ observations of apple diameter. 
Remember, the apples were **randomly selected from random trees from a field**. 

If we used the default model in most software, we would assume  

$$\mathbf{y} \sim N(\boldsymbol{\mu}, \Sigma),\\
\begin{bmatrix}y_1 \\ y_2 \\ y_3 \\ y_4 \\ \vdots \\ y_n \end{bmatrix} \sim N
\left( \begin{bmatrix}\mu_1 \\ \mu_2 \\ \mu_3 \\ \mu_4 \\ \vdots \\ \mu_n \end{bmatrix}, 
\sigma^2 
\begin{bmatrix} 1 & 0 & 0 & 0 & \dots & 0 \\ 
0 & 1 & 0 & 0 & \dots & 0 \\
0 & 0 & 1 & 0 & \dots & 0 \\
0 & 0 & 0 & 1 & \dots & 0 \\
\vdots & \vdots & \vdots & \vdots & \ddots & \vdots\\  
0 & 0 & 0 & 0 & \dots & 1 \end{bmatrix}
\right),$$

which is the same as 

$$\begin{bmatrix}y_1 \\ y_2 \\ y_3 \\ y_4 \\ \vdots \\ y_n \end{bmatrix} \sim N
\left( \begin{bmatrix}\mu_1 \\ \mu_2 \\ \mu_3 \\ \mu_4 \\ \vdots \\ \mu_n \end{bmatrix}, 
\begin{bmatrix} \sigma^2 & 0 & 0 & 0 & \dots & 0 \\ 
0 & \sigma^2 & 0 & 0 & \dots & 0 \\
0 & 0 & \sigma^2 & 0 & \dots & 0 \\
0 & 0 & 0 & \sigma^2 & \dots & 0 \\
\vdots & \vdots & \vdots & \vdots & \ddots & \vdots\\  
0 & 0 & 0 & 0 & \dots & \sigma^2 \end{bmatrix}
\right).$$

Discuss the assumptions:
- Linearity  
- Constant variance  
- **Independence**  
- Normality  


### Non-independent observations  

Now, imagine that the observations are actually diameters from random apples, but they were taken from 5 different fields. 
These observations are no longer independent, because apples from the same field are more similar to each other than apples from different fields.
This is when mixed-effects models enter the story - they allow us to indicate *what is similar to what* via random effects. 
In this case, we expect the growth rate to be similar among fields, but the baseline (a.k.a., the intercept) to be field-specific. Then,   

$$y_{ij} = \beta_{0j} + x_{ij} \beta_1 + \varepsilon_{ij}, \\ \varepsilon_{ij} \sim N(0, \sigma^2),$$  


{% include modal.html button="Example data" color="success" title="Example data" 
text='<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed vs Random Effects Table</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>

<body>
    <table>
        <tr>
            <th>day</th>
            <th>diameter_cm</th>
            <th>field</th>
        </tr>
        <tr>
            <td>3</td>
            <td>2.9</td>
            <td>A</td>
        </tr>
        <tr>
            <td>3</td>
            <td>2.8</td>
            <td>B</td>
        </tr>
        <tr>
            <td>3</td>
            <td>2.9</td>
            <td>C</td>
        </tr>
        <tr>
            <td>3</td>
            <td>2.7</td>
            <td>D</td>
        </tr>
        <tr>
            <td>3</td>
            <td>3.0</td>
            <td>E</td>
        </tr>
        <tr>
            <td>6</td>
            <td>3.6</td>
            <td>A</td>
        </tr>
        <tr>
            <td>6</td>
            <td>3.9</td>
            <td>B</td>
        </tr>
        <tr>
            <td>6</td>
            <td>3.7</td>
            <td>C</td>
        </tr>
        <tr>
            <td>6</td>
            <td>3.8</td>
            <td>D</td>
        </tr>
        <tr>
            <td>6</td>
            <td>3.7</td>
            <td>E</td>
        </tr>
    </table>
</body>

These data would mean  

$$\mathbf{y} = \begin{bmatrix} 
2.9 \\
2.8 \\
2.9 \\
2.7 \\
3.0 \\
3.6 \\
3.9 \\
3.7 \\
3.8 \\
3.7 \end{bmatrix}$$.

For the all-fixed model, 
$$\mathbf{X} = \begin{bmatrix} 
1 & 3 & 1 & 0 & 0 & 0 & 0 \\
1 & 3 & 0 & 1 & 0 & 0 & 0 \\
1 & 3 & 0 & 0 & 1 & 0 & 0 \\
1 & 3 & 0 & 0 & 0 & 1 & 0 \\
1 & 3 & 0 & 0 & 0 & 0 & 1 \\
1 & 6 & 1 & 0 & 0 & 0 & 0 \\
1 & 6 & 0 & 1 & 0 & 0 & 0 \\
1 & 6 & 0 & 0 & 1 & 0 & 0 \\
1 & 6 & 0 & 0 & 0 & 1 & 0 \\
1 & 6 & 0 & 0 & 0 & 0 & 1 \end{bmatrix}.$$

For the mixed model, 

$$\mathbf{X} = \begin{bmatrix} 
1 & 3 \\
1 & 3 \\
1 & 3 \\
1 & 3 \\
1 & 3 \\
1 & 6 \\
1 & 6 \\
1 & 6 \\
1 & 6 \\
1 & 6 \end{bmatrix},$$
$$\mathbf{Z} = \begin{bmatrix} 
1 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 1 \\
1 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 1 \end{bmatrix}.$$
' %}

### How do we define $$\beta_{0j}$$?

#### Fixed   

So far, we could have defined an all-fixed model. 

$$y_{ij} = \beta_{0j} + x_{ij} \beta_1 + \varepsilon_{ij}, \\ \beta_{0j} = \beta_0 + u_j \\ \varepsilon_{ij} \sim N(0, \sigma^2),$$  

where $$u_j$$ is the effect of the $$j$$th field on the intercept (i.e., on the baseline). 
In this case, $$u_j$$ is a fixed effect, which means it may be estimated via least squares estimation or maximum likelihood estimation. 
Under both least squares and maximum likelihood (assuming normal distribution), we may estimate the parameters by computing 

$$\hat{\boldsymbol{\beta}}_{ML} = (\mathbf{X}^T\mathbf{X})^{-1}\mathbf{X}^T\mathbf{y},$$

which yields the minimum variance unbiased estimate of $$\boldsymbol{\beta}$$. 

#### Random   

We could also assume that the effects of the $$j$$th tree (i.e., $$b_j$$) arise from a random distribution. 
The most common assumption (and the default in most statistical software) is that 

$$u_j \sim N(0, \sigma^2_b).$$

Now, we don't estimate the effect, but the variance $$\sigma^2_b$$. 
Note that there are $$J$$ levels of the random effects, meaning they are **categorical**.  
Also, now 

$$\hat{\boldsymbol{\beta}}_{REML} = (\mathbf{X}^T \mathbf{V}^{-1} \mathbf{X})^{-1}\mathbf{X}^T \mathbf{V}^{-1} \mathbf{y},$$

where $$\mathbf{V} = Var(\mathbf{y})$$ is the variance-covariance matrix of $$\mathbf{y}$$, 
including residual variance and random-effects variance. Note that this formula yields 
the same point estimate for $$\boldsymbol{\beta}$$, but with a different confidence interval.  


## Generalities -- what are mixed models anyways?

Mixed models combine fixed effects and random effects. 
Generally speaking, we can write out a mixed-effects model using the model equation form, as   

$$\mathbf{y} = \mathbf{X} \boldsymbol{\beta} + \mathbf{Z}\mathbf{u} + \boldsymbol{\varepsilon}, \\ 
\begin{bmatrix}\mathbf{u} \\ \boldsymbol{\varepsilon} \end{bmatrix} \sim \left(
\begin{bmatrix}\boldsymbol{0} \\ \boldsymbol{0} \end{bmatrix}, 
\begin{bmatrix}\mathbf{G} & \boldsymbol{0} \\
\boldsymbol{0} & \mathbf{V} \end{bmatrix} 
\right),$$

where $$\mathbf{y}$$ is the observed response, 
$$\mathbf{X}$$ is the matrix with the explanatory variables, 
$$\mathbf{Z}$$ is the design matrix,
$$\boldsymbol{\beta}$$ is the vector containing the fixed-effects, 
$$\mathbf{u}$$ is the vector containing the random effects, 
$$\boldsymbol{\varepsilon}$$ is the vector containing the residuals, 
$$\mathbf{G}$$ is the variance-covariance matrix of the random effects, 
and $$\mathbf{R}$$ is the variance-covariance matrix of the residuals. 
Note that $$\mathbf{X} \boldsymbol{\beta}$$ is the fixed effects part of the model, and 
$$\mathbf{Z}\mathbf{u}$$ is the random effects part of the model.



{% include modal.html button="Example for <strong>X</strong> and <strong>Z</strong>" color="success" 
title="Example for <strong>X</strong> and <strong>Z</strong>" 
text="<strong>Example A.</strong> Let's focus on the first 10 observations of apple diameter. 
Said first 10 observations of apple diameters include days 3 and 6 (which you can find in <strong>X</strong>), and one observation per field for each day (which you can find in <strong>Z</strong>). $$\mathbf{X} = \begin{array}{cc}  
\text{Int} \phantom{-} \text{day} \\ 
\begin{bmatrix} 
1 & 3 \\
1 & 6 \\
1 & 3 \\
1 & 6 \\
1 & 3 \\
1 & 6 \\
1 & 3 \\
1 & 6 \\
1 & 3 \\
1 & 6 
\end{bmatrix} 
\end{array}$$, $$\mathbf{Z} = \begin{array}{cc}
\text{f}1 \phantom{-} \text{f}2 \phantom{-} \text{f}3 \phantom{-} \text{f}4 \phantom{-} \text{f}5 \\ 
\begin{bmatrix} 1 & 0 & 0 & 0 & 0 \\
1 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 1 \\
0 & 0 & 0 & 0 & 1 \end{bmatrix}
\end{array}$$

------

<strong>Example B.</strong> Let's focus on the first 10 observations of apple diameter. 
In this case, we aim to predict <strong>final</strong> diameter based on the apple variety: Red delicious (RD), Gala (G) or Fuji (F).
You can still find this information in <strong>X</strong>, . The <strong>Z</strong> matrix remains the same. 

$$\begin{array}{ccc}  
& \text{RD} \phantom{-} \text{G} \phantom{-} \text{F} \\ 
\mathbf{X} = &
\begin{bmatrix} 
1 & 0 & 0 \\
1 & 0 & 0 \\
1 & 0 & 0 \\
0 & 0 & 1 \\
0 & 0 & 1 \\
0 & 0 & 1 \\
0 & 1 & 0 \\
0 & 1 & 0 \\
0 & 1 & 0 \\
0 & 1 & 0 
\end{bmatrix} 
\end{array}$$, 
$$\mathbf{Z} = \begin{array}{cc}
\text{f}1 \phantom{-} \text{f}2 \phantom{-} \text{f}3 \phantom{-} \text{f}4 \phantom{-} \text{f}5 \\ 
\begin{bmatrix} 
1 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 1 \\
1 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 1 \end{bmatrix}
\end{array}$$
" %}

Using the probability distribution form, we can then say that $$E(\mathbf{y}) = \mathbf{X}\boldsymbol{\beta}$$ 
and $$Var(\mathbf{y}) = \mathbf{V} = \mathbf{Z}\mathbf{G}\mathbf{Z}' + \mathbf{R}$$. 
Usually, we assume $$\mathbf{G} = \sigma^2_u 
\begin{bmatrix} 1 & 0 & 0 & \dots 0 \\
0 & 1 & 0 & \dots 0 \\
0 & 0 & 1 & \dots 0 \\
\vdots & \vdots & \vdots & \ddots & \vdots \\
0 & 0 & 0 & \dots 1
\end{bmatrix} $$ and  $$\mathbf{R} = \sigma^2 
\begin{bmatrix} 1 & 0 & 0 & \dots 0 \\
0 & 1 & 0 & \dots 0 \\
0 & 0 & 1 & \dots 0 \\
\vdots & \vdots & \vdots & \ddots & \vdots \\
0 & 0 & 0 & \dots 1
\end{bmatrix} $$. 

Then,   

$$\mathbf{y} \sim N(\boldsymbol{\mu}, \Sigma),$$  

$$\Sigma = \begin{bmatrix} \sigma^2 + \sigma^2_u & \sigma^2_u & 0 & 0 & 0 & 0 &\dots & 0\\
\sigma^2_u & \sigma^2 + \sigma^2_u & 0 & 0 & 0 & 0 & \dots & 0 \\
0 & 0 & \sigma^2 + \sigma^2_u & \sigma^2_u  & 0 & 0 & \dots & 0 \\
0 & 0 & \sigma^2_u & \sigma^2 + \sigma^2_u  & 0 & 0 & \dots & 0 \\
0 & 0 & 0 & 0 & \sigma^2 + \sigma^2_u & \sigma^2_u  & \dots & 0 \\
0 & 0 & 0 & 0 & \sigma^2_u & \sigma^2 + \sigma^2_u  & \dots & \vdots \\


\vdots & \vdots & \vdots & \vdots & \vdots & \vdots & \ddots & \vdots \\ 
0 & 0 & 0 & 0 & 0 & \dots & \sigma^2 + \sigma^2_u
\end{bmatrix}.$$

Take your time to digest the variance-covariance matrix above. What type of data do you think generated it? 

### Random effects    

- By definition, random effects are regression coefficients that arise from a random distribution. 
- Typically, a random effect $$u \sim N(0, \sigma^2_u)$$.   
- We estimate the variance $$\sigma^2_u$$.  
- Calculating degrees of freedom can get much more complex than in all-fixed effects models (e.g., with unbalanced data, spatio-temporally correlated data, or non-normal data).  
- In the context of designed experiments, random effects are assumed to be independent to each other and independent to the residual.  


**Estimation**  

Restricted maximum likelihood estimation (REML) is the default in most mixed effects models because, for small data (aka most experimental data), maximum likelihood (ML) provides variance estimates that are downward biased.
- In REML, the likelihood is maximized after accounting for the model’s fixed effects.  

- In ML, $$\ell_{ML}(\boldsymbol{\sigma; \boldsymbol{\beta}, \mathbf{y}}) = - (\frac{n}{2}) \log(2\pi)-(\frac{1}{2}) \log ( \vert \mathbf{V}(\boldsymbol\sigma) \vert ) - (\frac{1}{2}) (\mathbf{y}-\mathbf{X}\boldsymbol{\beta})^T[\mathbf{V}(\boldsymbol\sigma)]^{-1}(\mathbf{y}-\mathbf{X}\boldsymbol{\beta})$$  
- In REML, $$\ell_{REML}(\boldsymbol{\sigma};\mathbf{y}) = - (\frac{n-p}{2}) \log (2\pi) - (\frac{1}{2}) \log ( \vert \mathbf{V}(\boldsymbol\sigma) \vert ) - (\frac{1}{2})log \left(  \vert \mathbf{X}^T[\mathbf{V}(\boldsymbol\sigma)]^{-1}\mathbf{X} \vert \right) - (\frac{1}{2})\mathbf{r}[\mathbf{V}(\boldsymbol\sigma)]^{-1}\mathbf{r}$$, 
where $$p = rank(\mathbf{X})$$, $$\mathbf{r} = \mathbf{y}-\mathbf{X}\hat{\boldsymbol{\beta}}_{ML}$$.  
  - Start with initial values for $$\boldsymbol{\sigma}$$, $$\tilde{\boldsymbol{\sigma}}$$.  
  - Compute $$\mathbf{G}(\tilde{\boldsymbol{\sigma}})$$ and $$\mathbf{R}(\tilde{\boldsymbol{\sigma}})$$.  
  - Obtain $$\boldsymbol{\beta}$$ and $$\mathbf{b}$$.   
  - Update $$\tilde{\boldsymbol{\sigma}}$$.  
  - Repeat until convergence.  


### Fixed effects versus random effects  

**Group discussion:** what determines if an effect should be random of fixed? 
Consider the assumptions:  

- $$\hat{\boldsymbol{\beta}} \sim N \left( \boldsymbol{\beta}, (\mathbf{X}^T \mathbf{V}^{-1} \mathbf{X})^{-1} \right) $$ 
- $$u_j \sim N(0, \sigma^2_u)$$ 
- What process is being studied?  
- How were the levels selected? (randomly, carefully selected)  
- How many levels does the factor have, vs. how many did we observe?   

Some good references:  
- Page 20 in Gelman (2005). "Analysis of variance—why it is more important than ever". [[link](https://projecteuclid.org/journals/annals-of-statistics/volume-33/issue-1/Analysis-of-variancewhy-it-is-more-important-than-ever/10.1214/009053604000001048.full)]


## Applied example  

-   Field experiment at Colby, KS.  
-   One treatment factor: genotype (treatment structure).  
-   Randomized Complete Block Design with 3 repetitions (design structure).  


{% include figure.html img="day1/applied_example_rcbd.jpg" alt="" caption="Figure 5. Designed experiment. Colors indicate different genotypes." width="50%" id = "applied_ex" %}

### Building the model  

1. What is the *experiment blueprint*? (aka design structure)  
2. What are the treatments?  

We can easily come up with two models:

1.  Blocks fixed $$y_{ijk} = \mu + \tau_i + \rho_j + \varepsilon_{ijk}; \ \ \varepsilon \sim N(0, \sigma^2)$$.  
2.  Blocks random $$y_{ijk} = \mu + \tau_i + u_j + \varepsilon_{ijk}; \ \ u_j \sim N(0, \sigma^2_u); \ \ \varepsilon \sim N(0, \sigma^2)$$, 
where $$u$$ and $$\varepsilon$$ are independent.

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Embed R Code</title>
    <style>
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow-x: auto; /* Enables horizontal scrolling if the code is too wide */
        }
    </style>
</head>
<body>
    <pre>
<code>
library(glmmTMB)
library(agridat)

data(gilmour.serpentine)
dd <- gilmour.serpentine

m1 <- glmmTMB(yield ~ 1 + gen + rep, data = dd)
m2 <- glmmTMB(yield ~ 1 + gen + (1|rep), data = dd)

m1

</code>
    </pre>
</body>
</html>

{% highlight text %}
## Formula:          yield ~ 1 + gen + rep
## Data: dd
##       AIC       BIC    logLik  df.resid 
##  4159.176  4577.076 -1969.588       220 
## 
## Number of obs: 330
## 
## Dispersion estimate for gaussian family (sigma^2): 8.95e+03 
## 
## Fixed Effects:
## 
## Conditional model:
##     (Intercept)  gen(WqKPWmH*3Ag         genAMERY         genANGAS        genAROONA       genBATAVIA  
##        720.2473          24.3341         -93.3320        -132.6651        -153.6650        -175.3316  
##        genBD231        genBEULAH         genBLADE  genBT_SCHOMBURG        genCADOUX        genCONDOR  
##        -70.3321        -173.6649        -269.9978         -48.9988        -223.3313        -124.3318  
##     genCORRIGIN    genCUNNINGHAM  genDGR/MNX-9-9e    genDOLLARBIRD     genEXCALIBUR        genGOROKE  
##       -217.6647        -254.6645         -47.6655        -200.6648         -54.9988        -141.6651  
##      genHALBERD       genHOUTMAN          genJANZ      genK2011-5*       genKATUNGA         genKIATA  
##        -53.3322        -209.3314        -214.6647         -87.3320        -110.3319        -165.6649  
##         genKITE         genKULIN          genLARK         genLOWAN         genM4997         genM5075  
##       -179.9982         -90.9986        -336.3308        -152.3317        -145.9984        -194.6648  
##        genM5097       genMACHETE       genMEERING      genMOLINEUX        genOSPREY         genOUYEN  
##       -102.6653        -231.3313        -247.6646        -165.6649        -161.9983        -136.6651  
##        genOXLEY       genPELSART       genPEROUSE        genRAC655     genRAC655'S'        genRAC696  
##       -221.6647        -200.3314        -283.6644        -112.6652        -113.6652          -3.6657  
##       genRAC710        genRAC750        genRAC759        genRAC772        genRAC777        genRAC779  
##        -50.9988         -77.3320         -41.9989           5.0009        -172.3316           3.6676  
##       genRAC787        genRAC791        genRAC792        genRAC798        genRAC804        genRAC805  
##       -117.9985         -72.6654        -102.3319          -1.6657         -44.9989         -42.9989  
##       genRAC806        genRAC807        genRAC808        genRAC809        genRAC810        genRAC811  
##        -35.3322         -91.3320         -53.9988         -43.3322        -131.6651          42.3340  
##       genRAC812        genRAC813        genRAC814        genRAC815        genRAC816        genRAC817  
##        -93.9986         -83.3320         -72.3321        -110.9985         -66.3321         -99.9986  
##       genRAC818        genRAC819        genRAC820        genRAC821       genROSELLA    genSCHOMBURGK  
##       -106.9986        -121.3318          -0.9991         -98.3319        -184.3315        -132.3318  
##       genSHRIKE         genSPEAR      genSTILETTO        genSUNBRI      genSUNFIELD       genSUNLAND  
##       -127.9985        -254.6645        -156.9983        -218.3314        -206.6647        -182.6649  
##        genSWIFT        genTASMAN       genTATIARA     genTINCURRIN       genTRIDENT         genVF299  
##       -196.9981        -160.9983         -64.3321         -18.9984        -132.6651         -66.3321  
##        genVF300         genVF302         genVF508         genVF519         genVF655         genVF664  
##       -111.6652        -108.3319          11.6675          -0.9991        -160.1644        -106.6652  
##        genVG127         genVG503         genVG506         genVG701         genVG714         genVG878  
##       -109.6652         -42.9989        -108.6652         -19.3323        -108.3319          52.3340  
##      genWARBLER         genWI216         genWI221         genWI231         genWI232      genWILGOYNE  
##       -216.9980           4.0009         -17.3323        -218.3314         -56.3321        -130.9984  
##       genWW1402        genWW1477        genWW1831         genWYUNA    genYARRALINKA            repR2  
##       -117.3318        -185.6643         -86.6653        -176.6649        -244.9979          96.0996  
##           repR3  
##       -129.8458
{% endhighlight %}


{% highlight r %}
m2
{% endhighlight %}



{% highlight text %}
## Formula:          yield ~ 1 + gen + (1 | rep)
## Data: dd
##       AIC       BIC    logLik  df.resid 
##  4174.135  4588.237 -1978.068       221 
## Random-effects (co)variances:
## 
## Conditional model:
##  Groups   Name        Std.Dev.
##  rep      (Intercept) 92.14   
##  Residual             95.02   
## 
## Number of obs: 330 / Conditional model: rep, 3
## 
## Dispersion estimate for gaussian family (sigma^2): 9.03e+03 
## 
## Fixed Effects:
## 
## Conditional model:
##     (Intercept)  gen(WqKPWmH*3Ag         genAMERY         genANGAS        genAROONA       genBATAVIA  
##         709.000           24.333          -93.333         -132.667         -153.667         -175.333  
##        genBD231        genBEULAH         genBLADE  genBT_SCHOMBURG        genCADOUX        genCONDOR  
##         -70.333         -173.667         -270.000          -49.000         -223.333         -124.333  
##     genCORRIGIN    genCUNNINGHAM  genDGR/MNX-9-9e    genDOLLARBIRD     genEXCALIBUR        genGOROKE  
##        -217.667         -254.667          -47.667         -200.667          -55.000         -141.667  
##      genHALBERD       genHOUTMAN          genJANZ      genK2011-5*       genKATUNGA         genKIATA  
##         -53.333         -209.333         -214.667          -87.333         -110.333         -165.667  
##         genKITE         genKULIN          genLARK         genLOWAN         genM4997         genM5075  
##        -180.000          -91.000         -336.333         -152.333         -146.000         -194.667  
##        genM5097       genMACHETE       genMEERING      genMOLINEUX        genOSPREY         genOUYEN  
##        -102.667         -231.333         -247.667         -165.667         -162.000         -136.667  
##        genOXLEY       genPELSART       genPEROUSE        genRAC655     genRAC655'S'        genRAC696  
##        -221.667         -200.333         -283.667         -112.667         -113.667           -3.667  
##       genRAC710        genRAC750        genRAC759        genRAC772        genRAC777        genRAC779  
##         -51.000          -77.333          -42.000            5.000         -172.333            3.667  
##       genRAC787        genRAC791        genRAC792        genRAC798        genRAC804        genRAC805  
##        -118.000          -72.667         -102.333           -1.667          -45.000          -43.000  
##       genRAC806        genRAC807        genRAC808        genRAC809        genRAC810        genRAC811  
##         -35.333          -91.333          -54.000          -43.333         -131.667           42.333  
##       genRAC812        genRAC813        genRAC814        genRAC815        genRAC816        genRAC817  
##         -94.000          -83.333          -72.333         -111.000          -66.333         -100.000  
##       genRAC818        genRAC819        genRAC820        genRAC821       genROSELLA    genSCHOMBURGK  
##        -107.000         -121.333           -1.000          -98.333         -184.333         -132.333  
##       genSHRIKE         genSPEAR      genSTILETTO        genSUNBRI      genSUNFIELD       genSUNLAND  
##        -128.000         -254.667         -157.000         -218.333         -206.667         -182.667  
##        genSWIFT        genTASMAN       genTATIARA     genTINCURRIN       genTRIDENT         genVF299  
##        -197.000         -161.000          -64.333          -19.000         -132.667          -66.333  
##        genVF300         genVF302         genVF508         genVF519         genVF655         genVF664  
##        -111.667         -108.333           11.667           -1.000         -160.167         -106.667  
##        genVG127         genVG503         genVG506         genVG701         genVG714         genVG878  
##        -109.667          -43.000         -108.667          -19.333         -108.333           52.333  
##      genWARBLER         genWI216         genWI221         genWI231         genWI232      genWILGOYNE  
##        -217.000            4.000          -17.333         -218.333          -56.333         -131.000  
##       genWW1402        genWW1477        genWW1831         genWYUNA    genYARRALINKA  
##        -117.333         -185.667          -86.667         -176.667         -245.000
{% endhighlight %}

------

## Wrap-up  

Now we know what we mean when we say "factor A was considered fixed and factor B was considered random"!  

**Group discussion:** What to write in the Materials and Methods section of a paper. 
- Field-specific consensus  
- Enough to be reproducible 


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed vs Random Effects Table</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>

<body>

<table>
    <tr>
        <th> </th>
        <th>Fixed effects</th>
        <th>Random effects</th>
    </tr>
    <tr>
        <th>Where</th>
        <td>Expected value</td>
        <td>Variance-covariance matrix</td>
    </tr>
    <tr>
        <th>Inference</th>
        <td>Constant for all groups in the population of study</td>
        <td>Differ from group to group</td>
    </tr>
    <tr>
        <th>Usually used to model</th>
        <td>Carefully selected treatments or genotypes</td>
        <td>The study design (aka structure in the data, or what is similar to what)</td>
    </tr>
    <tr>
        <th>Assumptions</th>
        <td>$$\hat{\boldsymbol{\beta}} \sim N \left( \boldsymbol{\beta}, (\mathbf{X}^T \mathbf{V}^{-1} \mathbf{X})^{-1} \right) $$</td>
        <td>$$u_j \sim N(0, \sigma^2_u)$$</td>
    </tr>
    <tr>
        <th>Method of estimation</th>
        <td>Maximum likelihood, least squares</td>
        <td>Restricted maximum likelihood (shrinkage)</td>
    </tr>
</table>
</body>

## What's next  

- Friday, same time, same place.  
- More applied examples and what they mean.  
- Some troubleshooting.  

Any questions? E-mail me!  


